services:
  aws:
    image: localstack/localstack
    ports:
      - 4566:4566
      - 4510-4559:4510-4559
    environment:
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - LAMBDA_EXECUTOR=docker
    volumes:
      - "./volume:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./cdk:/opt/code/cdk"
    working_dir: /opt/code/cdk

  s3:
    image: minio/minio
    ports:
      - 9000:9000 
      - 9001:9001
    volumes:
      - ./s3/data:/data 
      - ./s3/config:/root/.minio
    environment:
      MINIO_ROOT_USER: "admin"
      MINIO_ROOT_PASSWORD: "password" 
    command: server /data --console-address ':9001'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    
  
  createbuckets:
    image: minio/mc
    depends_on:
      - s3
    entrypoint: >
      /bin/sh -c "
      mc alias set my_minio http://s3:9000 admin password;
      mc mb --ignore-existing my_minio/mybucket;
      "
